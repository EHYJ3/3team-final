<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 50px;
        }
        .payment-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn-primary {
            width: 100%;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="payment-container">
        <h1 class="mb-4">Payment</h1>
        <form id="paymentForm">
            <input type="hidden" id="jobPostId" th:value="${jobPostId}" />
            <input type="hidden" id="amount" th:value="${amount}" />
            <div class="form-group">
                <label for="amount">Amount:</label>
                <input type="text" class="form-control" id="amountDisplay" th:value="${amount}" readonly />
            </div>
            <button type="button" class="btn btn-primary" onclick="startPayment()">Complete Payment</button>
        </form>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>
    function startPayment() {
        const IMP = window.IMP;
        IMP.init("imp67607271"); // Iamport 가맹점 번호

        const jobPostId = document.getElementById('jobPostId').value;
        const amount = document.getElementById('amount').value;

        const paymentData = {
            pg: "html5_inicis", // 사용할 PG사
            pay_method: "card",
            merchant_uid: 'ORD-' + new Date().getTime(), // 주문 고유번호
            name: "Job Post Payment", // 결제 상품명
            amount: amount,
            buyer_email: "", // 구매자 이메일
            buyer_name: "", // 구매자 이름
            buyer_tel: "" // 구매자 전화번호
        };

        IMP.request_pay(paymentData, function (rsp) {
            if (rsp.success) {
                // 결제 성공 시, 서버에 결제 결과 전송
                $.post("/jobPost/completePayment", {
                    jobPostId: jobPostId,
                    paymentStatus: "After Payment",
                    imp_uid: rsp.imp_uid, // 결제 고유번호
                    merchant_uid: rsp.merchant_uid // 주문 고유번호
                }).done(function (data) {
                    alert('Payment successful!');
                    window.location.href = '/jobPost/jobPostList'; // 결제 후 리디렉션
                }).fail(function () {
                    alert('Payment failed.');
                });
            } else {
                // 결제 실패 시
                alert('Payment failed: ' + rsp.error_msg);
            }
        });
    }
</script>
</body>
</html>
